#!/usr/bin/expect -f

# Generated by Ansible 
#
# Any local changes will be deleted.
#

# Controller config without HA enabled

set DEFAULT_INSTALLATION_LOCATION "/opt/AppDynamics/Controller"

set INSTALLATION_LOCATION "{{ appdynamics_controller_install_dir }}"

set DEFAULT_APPSERVER_PORT "8090"
set APPSERVER_PORT "{{ appdynamics_controller_appserver_port }}"

set DEFAULT_DATABASE_PORT "3388"
set DATABASE_PORT "{{ appdynamics_controller_database_port }}"

set DEFAULT_ADMIN_PORT "4848"
set ADMIN_PORT "{{ appdynamics_controller_admin_port }}"

set DEFAULT_JMS_PORT "7676"
set JMS_PORT "{{ appdynamics_controller_jms_port }}"

set DEFAULT_IIOP_PORT "3700"
set IIOP_PORT "{{ appdynamics_controller_iiop_port }}"

set DEFAULT_SSL_PORT "8181"
set SSL_PORT "{{ appdynamics_controller_ssl_port }}"


spawn "{{ appdynamics_controller_home }}/bin/controller_64bit_linux_{{ appdynamics_controller_version }}.sh"
set timeout 600

expect {
  # Install the controller?
  "OK \\\[o, Enter\\\], Cancel \\\[c\\\]\r\n$" {
    send "o\r"
    exp_continue
  }
  # Terms & Conditions Agreement
  "Yes \\\[1\\\], No \\\[2\\\]\r\n$" {
    send "1\r"
    exp_continue
  }
  # Usage stats
  "Do we have your consent to collect usage data statistics?\r\nYes \\\[y, Enter\\\], No \\\[n\\\]\r\n$" {
    send "n\r"
    exp_continue
  }
  # Installation Location
  "Where should AppDynamics Controller be installed?\r\n\\\[/home/webapps/AppDynamics/Controller\\\]\r\n$" {
    send "$INSTALLATION_LOCATION\r"
    exp_continue
  }
  "already exists. Would you like to install to that directory anyway?\r\nYes \\\[y, Enter\\\], No \\\[n\\\]\r\n$" {
    send "y\r"
    exp_continue
  }
  # hostname
    -re "\\\[$DEFAULT_APPSERVER_PORT\\\]\r\n$" {
    send_user -- "$env(HOSTNAME)\n"
    exp_continue
  }
  # appserver port
  -re "\\\[$DEFAULT_APPSERVER_PORT|$APPSERVER_PORT\\\]\r\n$" {
    send "$APPSERVER_PORT\r"
    exp_continue
  }
  # database port
  -re "\\\[$DEFAULT_DATABASE_PORT|$DATABASE_PORT\\\]\r\n$" {
    send "$DATABASE_PORT\r"
    exp_continue
  }
  # appserver admin port
  -re "\\\[$DEFAULT_ADMIN_PORT|$ADMIN_PORT\\\]\r\n$" {
    send "$ADMIN_PORT\r"
    exp_continue
  }
  # appserver JMS port
  -re "\\\[$DEFAULT_JMS_PORT|$JMS_PORT\\\]\r\n$" {
    send "$JMS_PORT\r"
    exp_continue
  }
  # appserver IIOP port
  -re "\\\[$DEFAULT_IIOP_PORT|$IIOP_PORT\\\]\r\n$" {
    send "$IIOP_PORT\r"
    exp_continue
  }
  # appserver SSL port
  -re "\\\[$DEFAULT_SSL_PORT|$SSL_PORT\\\]\r\n$" {
    send "$SSL_PORT\r"
    exp_continue
  }
  # tenancy mode
  "Single Tenancy Mode \\\[1\\\], Multi Tenancy Mode \\\[2\\\]\r\n$" {
    send "{{ appdynamics_controller_tenancy_mode }}\n"
    exp_continue
  }
  # admin username
  "\\\[\\\]\r\n$" {
    send "{{ appdynamics_controller_admin_user }}\n"
    exp_continue
  }
  # admin password
  "Password\r\n$" {
    send "{{ appdynamics_controller_admin_password }}\n"
    exp_continue
  }
  # admin password confirmation
  "Reenter Password\r\n$" {
    send "{{ appdynamics_controller_admin_password }}\n"
    exp_continue
  }
  # AppDynamics profile
  "Demo \\\[1\\\], Small \\\[2\\\], Medium \\\[3\\\], Large \\\[4\\\], Extra Large \\\[5\\\]\r\n$" {
    send "{{ appdynamics_controller_install_profile }}\r"
    exp_continue
  }
  # Data directory
  -re "\\\[$DEFAULT_INSTALLATION_LOCATION\\\/db\\\/data|$INSTALLATION_LOCATION\\\/db\\\/data\\\]\r\n$" {
    send "$INSTALLATION_LOCATION/db/data\r"
    exp_continue
  }
  # Continue?
  "Continue?\r\nYes \\\[y, Enter\\\], No \\\[n\\\]\r\n$" {
    send "y\r"
    exp_continue
  } 
  # HA mode
  "Not Applicable (Not HA Enabled) \\\[1\\\], HA Primary Controller \\\[2\\\], HA Secondary Controller \\\[3\\\]\r\n$" {
    send "{{ appdynamics_controller_ha_mode }}\r"
    exp_continue
  }
  "Finishing installation ...\r\n$" {
    send "\r"
    exp_continue
  }
  "\\\[Enter\\\]\r\n$" {
    send "\r"
    exp_continue
  }
}
